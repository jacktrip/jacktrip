<svg width="600" height="700" xmlns="http://www.w3.org/2000/svg">
  <!-- Start -->
  <ellipse cx="300" cy="40" rx="60" ry="20" fill="none" stroke="black" stroke-width="2"/>
  <text x="300" y="45" font-family="sans-serif" font-size="10" text-anchor="middle">START</text>
  
  <!-- Initialize -->
  <rect x="220" y="80" width="160" height="40" fill="none" stroke="black" stroke-width="1"/>
  <text x="300" y="95" font-family="sans-serif" font-size="9" text-anchor="middle">new_pkts = count packets</text>
  <text x="300" y="110" font-family="sans-serif" font-size="9" text-anchor="middle">i = new_pkts - 1</text>
  
  <!-- Decision: i >= 0? -->
  <polygon points="300,150 350,180 300,210 250,180" fill="none" stroke="black" stroke-width="2"/>
  <text x="300" y="178" font-family="sans-serif" font-size="9" text-anchor="middle">i ≥ 0?</text>
  <text x="300" y="190" font-family="sans-serif" font-size="9" text-anchor="middle"></text>
  
  <!-- Get candidate packet -->
  <rect x="420" y="160" width="140" height="40" fill="none" stroke="black" stroke-width="1"/>
  <text x="490" y="175" font-family="sans-serif" font-size="9" text-anchor="middle">candidate = packet[next+i]</text>
  <text x="490" y="190" font-family="sans-serif" font-size="9" text-anchor="middle">age = now - arrival_time</text>
  
  <!-- Decision: age <= tolerance? -->
  <polygon points="490,230 540,260 490,290 440,260" fill="none" stroke="black" stroke-width="2"/>
  <text x="490" y="258" font-family="sans-serif" font-size="9" text-anchor="middle">age ≤</text>
  <text x="490" y="270" font-family="sans-serif" font-size="9" text-anchor="middle">tolerance?</text>
  
  <!-- Update sequence and goto PACKET_OK -->
  <rect x="420" y="320" width="140" height="40" fill="none" stroke="black" stroke-width="1"/>
  <text x="490" y="335" font-family="sans-serif" font-size="9" text-anchor="middle">mLastSeqNumOut = candidate</text>
  <text x="490" y="350" font-family="sans-serif" font-size="9" text-anchor="middle">goto PACKET_OK</text>
  
  <!-- Increment skipped and decrement i -->
  <rect x="220" y="320" width="120" height="40" fill="none" stroke="black" stroke-width="1"/>
  <text x="280" y="335" font-family="sans-serif" font-size="9" text-anchor="middle">skipped++</text>
  <text x="280" y="350" font-family="sans-serif" font-size="9" text-anchor="middle">i--</text>
  
  <!-- UNDERRUN label -->
  <rect x="80" y="160" width="100" height="30" fill="none" stroke="black" stroke-width="2"/>
  <text x="130" y="180" font-family="sans-serif" font-size="10" text-anchor="middle" font-weight="bold">UNDERRUN</text>
  
  <!-- PACKET_OK decision -->
  <rect x="420" y="400" width="140" height="30" fill="none" stroke="black" stroke-width="2"/>
  <text x="490" y="420" font-family="sans-serif" font-size="10" text-anchor="middle" font-weight="bold">PACKET_OK</text>
  
  <!-- Decision: skipped > 0 and not lastGlitch? -->
  <polygon points="490,460 560,490 490,520 420,490" fill="none" stroke="black" stroke-width="2"/>
  <text x="490" y="485" font-family="sans-serif" font-size="8" text-anchor="middle">skipped > 0 &amp;</text>
  <text x="490" y="497" font-family="sans-serif" font-size="8" text-anchor="middle">not lastGlitch?</text>
  
  <!-- Process with GLITCH=true (prediction) -->
  <rect x="380" y="550" width="120" height="40" fill="none" stroke="black" stroke-width="1"/>
  <text x="440" y="565" font-family="sans-serif" font-size="9" text-anchor="middle">processPacket</text>
  <text x="440" y="580" font-family="sans-serif" font-size="9" text-anchor="middle">(GLITCH=true)</text>
  
  <!-- Process with GLITCH=false (real data) -->
  <rect x="520" y="550" width="120" height="40" fill="none" stroke="black" stroke-width="1"/>
  <text x="580" y="565" font-family="sans-serif" font-size="9" text-anchor="middle">processPacket</text>
  <text x="580" y="580" font-family="sans-serif" font-size="9" text-anchor="middle">(GLITCH=false)</text>
  
  <!-- UNDERRUN process -->
  <rect x="70" y="550" width="120" height="40" fill="none" stroke="black" stroke-width="1"/>
  <text x="130" y="565" font-family="sans-serif" font-size="9" text-anchor="middle">processPacket</text>
  <text x="130" y="580" font-family="sans-serif" font-size="9" text-anchor="middle">(GLITCH=true)</text>
  
  <!-- End -->
  <ellipse cx="300" cy="640" rx="40" ry="20" fill="none" stroke="black" stroke-width="2"/>
  <text x="300" y="645" font-family="sans-serif" font-size="10" text-anchor="middle">END</text>
  
  <!-- Flow arrows -->
  <line x1="300" y1="60" x2="300" y2="80" stroke="black" stroke-width="1" marker-end="url(#arrowhead)"/>
  <line x1="300" y1="120" x2="300" y2="150" stroke="black" stroke-width="1" marker-end="url(#arrowhead)"/>
  
  <!-- YES arrow from i>=0 decision -->
  <line x1="350" y1="180" x2="420" y2="180" stroke="black" stroke-width="1" marker-end="url(#arrowhead)"/>
  <text x="385" y="175" font-family="sans-serif" font-size="8">YES</text>
  
  <!-- NO arrow from i>=0 decision to UNDERRUN -->
  <line x1="250" y1="180" x2="180" y2="180" stroke="black" stroke-width="1" marker-end="url(#arrowhead)"/>
  <text x="215" y="175" font-family="sans-serif" font-size="8">NO</text>
  
  <line x1="490" y1="200" x2="490" y2="230" stroke="black" stroke-width="1" marker-end="url(#arrowhead)"/>
  
  <!-- YES arrow from tolerance decision -->
  <line x1="490" y1="290" x2="490" y2="320" stroke="black" stroke-width="1" marker-end="url(#arrowhead)"/>
  <text x="505" y="305" font-family="sans-serif" font-size="8">YES</text>
  
  <!-- NO arrow from tolerance decision -->
  <line x1="440" y1="260" x2="340" y2="260" stroke="black" stroke-width="1"/>
  <line x1="340" y1="260" x2="340" y2="320" stroke="black" stroke-width="1" marker-end="url(#arrowhead)"/>
  <text x="390" y="255" font-family="sans-serif" font-size="8">NO</text>
  
  <!-- Loop back arrow -->
  <line x1="280" y1="320" x2="280" y2="300" stroke="black" stroke-width="1"/>
  <line x1="280" y1="300" x2="200" y2="300" stroke="black" stroke-width="1"/>
  <line x1="200" y1="300" x2="200" y2="180" stroke="black" stroke-width="1"/>
  <line x1="200" y1="180" x2="250" y2="180" stroke="black" stroke-width="1" marker-end="url(#arrowhead)"/>
  
  <!-- PACKET_OK flow -->
  <line x1="490" y1="360" x2="490" y2="400" stroke="black" stroke-width="1" marker-end="url(#arrowhead)"/>
  <line x1="490" y1="430" x2="490" y2="460" stroke="black" stroke-width="1" marker-end="url(#arrowhead)"/>
  
  <!-- Decision outcomes -->
  <line x1="460" y1="505" x2="440" y2="525" stroke="black" stroke-width="1"/>
  <line x1="440" y1="525" x2="440" y2="550" stroke="black" stroke-width="1" marker-end="url(#arrowhead)"/>
  <text x="420" y="520" font-family="sans-serif" font-size="8">YES</text>
  
  <line x1="520" y1="505" x2="580" y2="525" stroke="black" stroke-width="1"/>
  <line x1="580" y1="525" x2="580" y2="550" stroke="black" stroke-width="1" marker-end="url(#arrowhead)"/>
  <text x="600" y="520" font-family="sans-serif" font-size="8">NO</text>
  
  <!-- UNDERRUN to process -->
  <line x1="130" y1="190" x2="130" y2="550" stroke="black" stroke-width="1" marker-end="url(#arrowhead)"/>
  
  <!-- All paths to END -->
  <line x1="440" y1="590" x2="440" y2="610" stroke="black" stroke-width="1"/>
  <line x1="440" y1="610" x2="300" y2="610" stroke="black" stroke-width="1"/>
  <line x1="300" y1="610" x2="300" y2="620" stroke="black" stroke-width="1" marker-end="url(#arrowhead)"/>
  
  <line x1="580" y1="590" x2="580" y2="610" stroke="black" stroke-width="1"/>
  <line x1="580" y1="610" x2="300" y2="610" stroke="black" stroke-width="1"/>
  
  <line x1="130" y1="590" x2="130" y2="610" stroke="black" stroke-width="1"/>
  <line x1="130" y1="610" x2="300" y2="610" stroke="black" stroke-width="1"/>
  
  <!-- Arrow marker definition -->
  <defs>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="black"/>
    </marker>
  </defs>
</svg>

